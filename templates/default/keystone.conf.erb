<%= node["openstack"]["identity"]["custom_template_banner"] %>
[DEFAULT]

#
# From keystone
#

# A "shared secret" that can be used to bootstrap Keystone. This "token" does
# not represent a user, and carries no explicit authorization. To disable in
# production (highly recommended), remove AdminTokenAuthMiddleware from your
# paste application pipelines (for example, in keystone-paste.ini). (string
# value)
#admin_token = ADMIN
admin_token = <%= @bootstrap_token %>

# The base public endpoint URL for Keystone that is advertised to clients
# (NOTE: this does NOT affect how Keystone listens for connections). Defaults
# to the base host URL of the request. E.g. a request to
# http://server:5000/v3/users will default to http://server:5000. You should
# only need to set this value if the base URL contains a path (e.g. /prefix/v3)
# or the endpoint should be found on a different server. (string value)
#public_endpoint = <None>
public_endpoint = <%= @public_endpoint %>

# The base admin endpoint URL for Keystone that is advertised to clients (NOTE:
# this does NOT affect how Keystone listens for connections). Defaults to the
# base host URL of the request. E.g. a request to http://server:35357/v3/users
# will default to http://server:35357. You should only need to set this value
# if the base URL contains a path (e.g. /prefix/v3) or the endpoint should be
# found on a different server. (string value)
#admin_endpoint = <None>
admin_endpoint = <%= @admin_endpoint %>

<% if node['openstack']['identity']['list_limit'] %>
# The maximum number of entities that will be returned in a collection, with no
# limit set by default. This global limit may be then overridden for a specific
# driver, by specifying a list_limit in the appropriate section (e.g.
# [assignment]). (integer value)
#list_limit=<None>
list_limit=<%= node['openstack']['identity']['list_limit'] %>
<% end %>

#
# From keystone.notifications
#
#
# From keystone.openstack.common.eventlet_backdoor
#
#
# From keystone.openstack.common.policy
#

#
# From oslo.log
#

# Print debugging output (set logging level to DEBUG instead of default WARNING
# level). (boolean value)
#debug = false
debug = <%= node["openstack"]["identity"]["debug"] %>

# Print more verbose output (set logging level to INFO instead of default
# WARNING level). (boolean value)
#verbose = false
verbose = <%= node["openstack"]["identity"]["verbose"] %>

<% if node["openstack"]["identity"]["syslog"]["use"] %>
# The name of a logging configuration file. This file is appended to any
# existing logging configuration files. For details about logging configuration
# files, see the Python logging module documentation. (string value)
# Deprecated group/name - [DEFAULT]/log_config
#log_config_append = <None>
log_config_append = /etc/openstack/logging.conf
<% else %>
# (Optional) Name of log file to output to. If no default is set, logging will
# go to stdout. (string value)
# Deprecated group/name - [DEFAULT]/logfile
#log_file = <None>
log_file = /var/log/keystone/keystone.log
<% end %>

#
# From oslo.messaging
#

# Driver or drivers to handle sending notifications. (multi valued)
#notification_driver =
notification_driver = <%= node['openstack']['identity']['notification_driver'] %>

<% if @notification_driver == "messaging" -%>
# AMQP topic used for OpenStack notifications. (list value)
# Deprecated group/name - [rpc_notifier2]/topics
#notification_topics = notifications
notification_topics = <%= node["openstack"]["mq"]["identity"]["notification_topics"] %>

# Size of RPC thread pool. (integer value)
#rpc_thread_pool_size = 64
rpc_thread_pool_size = <%= node["openstack"]["identity"]["rpc_thread_pool_size"] %>

# Seconds to wait for a response from a call. (integer value)
#rpc_response_timeout = 60
rpc_response_timeout = <%= node["openstack"]["identity"]["rpc_response_timeout"] %>

# The messaging driver to use, defaults to rabbit. Other drivers include qpid
# and zmq. (string value)
#rpc_backend = rabbit
rpc_backend = <%= node["openstack"]["identity"]["rpc_backend"] %>

# The default exchange under which topics are scoped. May be overridden by an
# exchange name specified in the transport_url option. (string value)
#control_exchange = keystone
control_exchange = <%= node["openstack"]["identity"]["control_exchange"] %>

<% end -%>

[assignment]

#
# From keystone
#

# Assignment backend driver. (string value)
#driver = <None>
driver = keystone.assignment.backends.<%= node["openstack"]["identity"]["assignment"]["backend"] %>.Assignment

# Maximum number of entities that will be returned in an
# assignment collection. (integer value)
#list_limit=<None>
<% if node['openstack']['identity']['assignment']['list_limit'] %>
list_limit=<%= node['openstack']['identity']['assignment']['list_limit'] %>
<% end %>

[auth]

#
# From keystone
#

# The external (REMOTE_USER) auth plugin module. (String value)
external = <%= node['openstack']['identity']['auth']['external'] %>

# Default auth methods. (List value)
methods = <%= node['openstack']['identity']['auth']['methods'] %>

[cache]

#
# From keystone
#

[catalog]

#
# From keystone
#

# Catalog backend driver. (string value)
#driver = keystone.catalog.backends.sql.Catalog
<% if node["openstack"]["identity"]["catalog"]["backend"] == "templated" -%>
driver = keystone.catalog.backends.templated.TemplatedCatalog
<% else -%>
driver = keystone.catalog.backends.<%= node["openstack"]["identity"]["catalog"]["backend"] %>.Catalog
<% end -%>

<% if node['openstack']['identity']['catalog']['list_limit'] %>
# Maximum number of entities that will be returned in a catalog collection.
# (integer value)
#list_limit = <None>
list_limit=<%= node['openstack']['identity']['catalog']['list_limit'] %>
<% end %>

[credential]

#
# From keystone
#

[database]

#
# From oslo.db
#

# The SQLAlchemy connection string to use to connect to the database. (string
# value)
# Deprecated group/name - [DEFAULT]/sql_connection
# Deprecated group/name - [DATABASE]/sql_connection
# Deprecated group/name - [sql]/connection
#connection = <None>
connection = <%= @sql_connection %>

[endpoint_filter]

#
# Options defined in keystone
#

[endpoint_policy]

#
# From keystone
#
[eventlet_server]

#
# From keystone
#

<% if node["openstack"]["identity"]["public_workers"] %>
# The number of worker processes to serve the public eventlet application.
# Defaults to number of CPUs (minimum of 2). (integer value)
# Deprecated group/name - [DEFAULT]/public_workers
#public_workers = <None>
public_workers=<%= node["openstack"]["identity"]["public_workers"] %>
<% end %>

<% if node["openstack"]["identity"]["admin_workers"] %>
# The number of worker processes to serve the admin eventlet application.
# Defaults to number of CPUs (minimum of 2). (integer value)
# Deprecated group/name - [DEFAULT]/admin_workers
#admin_workers = <None>
admin_workers=<%= node["openstack"]["identity"]["admin_workers"] %>
<% end %>

# The IP address of the network interface for the public service to listen on.
# (string value)
# Deprecated group/name - [DEFAULT]/bind_host
# Deprecated group/name - [DEFAULT]/public_bind_host
#public_bind_host = 0.0.0.0
public_bind_host = <%= @bind_address %>

# The port number which the public service listens on. (integer value)
# Deprecated group/name - [DEFAULT]/public_port
#public_port = 5000
public_port = <%= @public_port %>

# The IP address of the network interface for the admin service to listen on.
# (string value)
# Deprecated group/name - [DEFAULT]/bind_host
# Deprecated group/name - [DEFAULT]/admin_bind_host
#admin_bind_host = 0.0.0.0
admin_bind_host = <%= @admin_bind_address %>

# The port number which the admin service listens on. (integer value)
# Deprecated group/name - [DEFAULT]/admin_port
#admin_port = 35357
admin_port = <%= @admin_port %>

<% if node['openstack']['identity']['ssl']['enabled'] %>
[eventlet_server_ssl]

#
# From keystone
#

enable = True
certfile = <%= node['openstack']['identity']['ssl']['certfile'] %>
keyfile = <%= node['openstack']['identity']['ssl']['keyfile'] %>
ca_certs = <%= node['openstack']['identity']['ssl']['ca_certs'] %>
# Require client certificate. (boolean value)
cert_required = <%= node['openstack']['identity']['ssl']['cert_required'] %>
<% end %>

[federation]

#
# Options defined in keystone
#

# Federation backend driver. (string value)
#driver=keystone.contrib.federation.backends.sql.Federation

# Value to be used when filtering assertion parameters from
# the environment. (string value)
#assertion_prefix=

[identity]

#
# From keystone
#

# This references the domain to use for all Identity API v2 requests (which are
# not aware of domains). A domain with this ID will be created for you by
# keystone-manage db_sync in migration 008. The domain referenced by this ID
# cannot be deleted on the v3 API, to prevent accidentally breaking the v2 API.
# There is nothing special about this domain, other than the fact that it must
# exist to order to maintain support for your v2 clients. (string value)
#default_domain_id = default
default_domain_id=<%= node["openstack"]["identity"]["identity"]["default_domain_id"] %>

# A subset (or all) of domains can have their own identity driver, each with
# their own partial configuration options, stored in either the resource
# backend or in a file in a domain configuration directory (depending on the
# setting of domain_configurations_from_database). Only values specific to the
# domain need to be specified in this manner. This feature is disabled by
# default; set to true to enable. (boolean value)
#domain_specific_drivers_enabled = false
domain_specific_drivers_enabled=<%= node["openstack"]["identity"]["identity"]["domain_specific_drivers_enabled"] %>

# Path for Keystone to locate the domain specific identity configuration files
# if domain_specific_drivers_enabled is set to true. (string value)
#domain_config_dir = /etc/keystone/domains
domain_config_dir=<%= node["openstack"]["identity"]["identity"]["domain_config_dir"] %>

# Identity backend driver. (string value)
#driver = keystone.identity.backends.sql.Identity
driver = keystone.identity.backends.<%= node["openstack"]["identity"]["identity"]["backend"] %>.Identity

<% if node['openstack']['identity']['identity']['list_limit'] %>
# Maximum number of entities that will be returned in an identity collection.
# (integer value)
#list_limit = <None>
list_limit=<%= node['openstack']['identity']['identity']['list_limit'] %>
<% end %>

[identity_mapping]

#
# From keystone
#

# Keystone Identity Mapping backend driver. (string value)
driver = <%= node['openstack']['identity']['identity_mapping']['driver'] %>

# Public ID generator for user and group entities in the keystone.identity.id_generator namespace.
# The Keystone identity mapper only supports generators that produce no more than 64 characters.
# (string value)
generator = <%= node['openstack']['identity']['identity_mapping']['generator'] %>

# The format of user and group IDs changed in Juno for backends that do not
# generate UUIDs (e.g. LDAP), with keystone providing a hash mapping to the
# underlying attribute in LDAP. By default this mapping is disabled, which
# ensures that existing IDs will not change. Even when the mapping is enabled
# by using domain specific drivers, any users and groups from the default
# domain being handled by LDAP will still not be mapped to ensure their IDs
# remain backward compatible. Setting this value to False will enable the
# mapping for even the default LDAP driver. It is only safe to do this if you
# do not already have assignments for users and groups from the default LDAP
# domain, and it is acceptable for Keystone to provide the different IDs to
# clients than it did previously.  Typically this means that the only time you
# can set this value to False is when configuring a fresh installation.
# (boolean value)
backward_compatible_ids = <%= node['openstack']['identity']['identity_mapping']['backward_compatible_ids'] %>

[kvs]

#
# From keystone
#

[ldap]

#
# From keystone
#

# URL for connecting to the LDAP server. (string value)
#url = ldap://localhost
url = <%= @ldap["url"] %>

# User BindDN to query the LDAP server. (string value)
#user = <None>
user = <%= @ldap["user"] %>

<% if @ldap["password"] -%>
# Password for the BindDN to query the LDAP server. (string value)
#password = <None>
password = <%= @ldap["password"] %>
<% end -%>

# LDAP server suffix (string value)
#suffix = cn=example,cn=com
suffix = <%= @ldap["suffix"] %>

# If true, will add a dummy member to groups. This is required if the
# objectclass for groups requires the "member" attribute. (boolean value)
#use_dumb_member = false
use_dumb_member = <%= @ldap["use_dumb_member"] %>

# DN of the "dummy member" to use when "use_dumb_member" is enabled. (string
# value)
#dumb_member = cn=dumb,dc=nonexistent
dumb_member = <%= @ldap["dumb_member"] %>

# Delete subtrees using the subtree delete control. Only enable this option if
# your LDAP server supports subtree deletion. (boolean value)
#allow_subtree_delete = false
allow_subtree_delete = <%= @ldap["allow_subtree_delete"] %>

# The LDAP scope for queries, this can be either "one" (onelevel/singleLevel)
# or "sub" (subtree/wholeSubtree). (string value)
#query_scope = one
query_scope = <%= @ldap["query_scope"] %>

# Maximum results per page; a value of zero ("0") disables paging. (integer
# value)
#page_size = 0
page_size = <%= @ldap["page_size"] %>

# The LDAP dereferencing option for queries. This can be either "never",
# "searching", "always", "finding" or "default". The "default" option falls
# back to using default dereferencing configured by your ldap.conf. (string
# value)
#alias_dereferencing = default
alias_dereferencing = <%= @ldap["alias_dereferencing"] %>

<% if @ldap["user_tree_dn"] -%>
# Search base for users. (string value)
#user_tree_dn = <None>
user_tree_dn = <%= @ldap["user_tree_dn"] %>
<% end -%>

<% if @ldap["user_filter"] -%>
# LDAP search filter for users. (string value)
#user_filter = <None>
user_filter = <%= @ldap["user_filter"] %>
<% end -%>

# LDAP objectclass for users. (string value)
#user_objectclass = inetOrgPerson
user_objectclass = <%= @ldap["user_objectclass"] %>

# LDAP attribute mapped to user id. WARNING: must not be a multivalued
# attribute. (string value)
#user_id_attribute = cn
user_id_attribute = <%= @ldap["user_id_attribute"] %>

# LDAP attribute mapped to user name. (string value)
#user_name_attribute = sn
user_name_attribute = <%= @ldap["user_name_attribute"] %>

# LDAP attribute mapped to user email. (string value)
#user_mail_attribute = mail
user_mail_attribute = <%= @ldap["user_mail_attribute"] %>

# LDAP attribute mapped to password. (string value)
#user_pass_attribute = userPassword
user_pass_attribute = <%= @ldap["user_pass_attribute"] %>

# LDAP attribute mapped to user enabled flag. (string value)
#user_enabled_attribute = enabled
user_enabled_attribute = <%= @ldap["user_enabled_attribute"] %>

# Bitmask integer to indicate the bit that the enabled value is stored in if
# the LDAP server represents "enabled" as a bit on an integer rather than a
# boolean. A value of "0" indicates the mask is not used. If this is not set to
# "0" the typical value is "2". This is typically used when
# "user_enabled_attribute = userAccountControl". (integer value)
#user_enabled_mask = 0
user_enabled_mask = <%= @ldap["user_enabled_mask"] %>

# Default value to enable users. This should match an appropriate int value if
# the LDAP server uses non-boolean (bitmask) values to indicate if a user is
# enabled or disabled. If this is not set to "True" the typical value is "512".
# This is typically used when "user_enabled_attribute = userAccountControl".
# (string value)
#user_enabled_default = True
user_enabled_default = <%= @ldap["user_enabled_default"] %>

# List of attributes stripped off the user on update. (list value)
#user_attribute_ignore = default_project_id,tenants
user_attribute_ignore = <%= @ldap["user_attribute_ignore"] %>

# Allow user creation in LDAP backend. (boolean value)
#user_allow_create = true
user_allow_create = <%= @ldap["user_allow_create"] %>

# Allow user updates in LDAP backend. (boolean value)
#user_allow_update = true
user_allow_update = <%= @ldap["user_allow_update"] %>

# Allow user deletion in LDAP backend. (boolean value)
#user_allow_delete = true
user_allow_delete = <%= @ldap["user_allow_delete"] %>

# If true, Keystone uses an alternative method to determine if a user is
# enabled or not by checking if they are a member of the
# "user_enabled_emulation_dn" group. (boolean value)
#user_enabled_emulation = false
user_enabled_emulation = <%= @ldap["user_enabled_emulation"] %>

<% if @ldap["user_enabled_emulation_dn"] -%>
# DN of the group entry to hold enabled users when using enabled emulation.
# (string value)
#user_enabled_emulation_dn = <None>
user_enabled_emulation_dn = <%= @ldap["user_enabled_emulation_dn"] %>
<% end -%>

<% if @ldap["project_tree_dn"] -%>
# Search base for projects (string value)
# Deprecated group/name - [ldap]/tenant_tree_dn
#project_tree_dn = <None>
project_tree_dn = <%= @ldap["project_tree_dn"] %>
<% end -%>

<% if @ldap["project_filter"] -%>
# LDAP search filter for projects. (string value)
# Deprecated group/name - [ldap]/tenant_filter
#project_filter = <None>
project_filter = <%= @ldap["project_filter"] %>
<% end -%>

# LDAP objectclass for projects. (string value)
# Deprecated group/name - [ldap]/tenant_objectclass
#project_objectclass = groupOfNames
project_objectclass = <%= @ldap["project_objectclass"] %>

# LDAP attribute mapped to project id. (string value)
# Deprecated group/name - [ldap]/tenant_id_attribute
#project_id_attribute = cn
project_id_attribute = <%= @ldap["project_id_attribute"] %>

# LDAP attribute mapped to project membership for user. (string value)
# Deprecated group/name - [ldap]/tenant_member_attribute
#project_member_attribute = member
project_member_attribute = <%= @ldap["project_member_attribute"] %>

# LDAP attribute mapped to project name. (string value)
# Deprecated group/name - [ldap]/tenant_name_attribute
#project_name_attribute = ou
project_name_attribute = <%= @ldap["project_name_attribute"] %>

# LDAP attribute mapped to project description. (string value)
# Deprecated group/name - [ldap]/tenant_desc_attribute
#project_desc_attribute = description
project_desc_attribute = <%= @ldap["project_desc_attribute"] %>

# LDAP attribute mapped to project enabled. (string value)
# Deprecated group/name - [ldap]/tenant_enabled_attribute
#project_enabled_attribute = enabled
project_enabled_attribute = <%= @ldap["project_enabled_attribute"] %>

# LDAP attribute mapped to project domain_id. (string value)
# Deprecated group/name - [ldap]/tenant_domain_id_attribute
#project_domain_id_attribute = businessCategory
project_domain_id_attribute = <%= @ldap["project_domain_id_attribute"] %>

<% if @ldap["project_attribute_ignore"] -%>
# List of attributes stripped off the project on update. (list value)
# Deprecated group/name - [ldap]/tenant_attribute_ignore
#project_attribute_ignore =
project_attribute_ignore = <%= @ldap["project_attribute_ignore"] %>
<% end -%>

# Allow project creation in LDAP backend. (boolean value)
# Deprecated group/name - [ldap]/tenant_allow_create
#project_allow_create = true
project_allow_create = <%= @ldap["project_allow_create"] %>

# Allow project update in LDAP backend. (boolean value)
# Deprecated group/name - [ldap]/tenant_allow_update
#project_allow_update = true
project_allow_update = <%= @ldap["project_allow_update"] %>

# Allow project deletion in LDAP backend. (boolean value)
# Deprecated group/name - [ldap]/tenant_allow_delete
#project_allow_delete = true
project_allow_delete = <%= @ldap["project_allow_delete"] %>

# If true, Keystone uses an alternative method to determine if a project is
# enabled or not by checking if they are a member of the
# "project_enabled_emulation_dn" group. (boolean value)
# Deprecated group/name - [ldap]/tenant_enabled_emulation
#project_enabled_emulation = false
project_enabled_emulation = <%= @ldap["project_enabled_emulation"] %>

<% if @ldap["project_enabled_emulation_dn"] -%>
# DN of the group entry to hold enabled projects when using enabled emulation.
# (string value)
# Deprecated group/name - [ldap]/tenant_enabled_emulation_dn
#project_enabled_emulation_dn = <None>
project_enabled_emulation_dn = <%= @ldap["project_enabled_emulation_dn"] %>
<% end -%>

<% if @ldap["role_tree_dn"] -%>
# Search base for roles. (string value)
#role_tree_dn = <None>
role_tree_dn = <%= @ldap["role_tree_dn"] %>
<% end -%>

<% if @ldap["role_filter"] -%>
# LDAP search filter for roles. (string value)
#role_filter = <None>
role_filter = <%= @ldap["role_filter"] %>
<% end -%>

# LDAP objectclass for roles. (string value)
#role_objectclass = organizationalRole
role_objectclass = <%= @ldap["role_objectclass"] %>

# LDAP attribute mapped to role id. (string value)
#role_id_attribute = cn
role_id_attribute = <%= @ldap["role_id_attribute"] %>

# LDAP attribute mapped to role name. (string value)
#role_name_attribute = ou
role_name_attribute = <%= @ldap["role_name_attribute"] %>

# LDAP attribute mapped to role membership. (string value)
#role_member_attribute=roleOccupant
role_member_attribute = <%= @ldap["role_member_attribute"] %>

<% if @ldap["role_attribute_ignore"] -%>
# List of attributes stripped off the role on update. (list value)
#role_attribute_ignore =
role_attribute_ignore = <%= @ldap["role_attribute_ignore"] %>
<% end -%>

# Allow role creation in LDAP backend. (boolean value)
#role_allow_create=true
role_allow_create = <%= @ldap["role_allow_create"] %>

# Allow role update in LDAP backend. (boolean value)
#role_allow_update=true
role_allow_update = <%= @ldap["role_allow_update"] %>

# Allow role deletion in LDAP backend. (boolean value)
#role_allow_delete=true
role_allow_delete = <%= @ldap["role_allow_delete"] %>

<% if @ldap["group_tree_dn"] -%>
# Search base for groups. (string value)
#group_tree_dn = <None>
group_tree_dn = <%= @ldap["group_tree_dn"] %>
<% end -%>

<% if @ldap["group_filter"] -%>
# LDAP search filter for groups. (string value)
#group_filter = <None>
group_filter = <%= @ldap["group_filter"] %>
<% end -%>

# LDAP objectclass for groups. (string value)
#group_objectclass = groupOfNames
group_objectclass = <%= @ldap["group_objectclass"] %>

# LDAP attribute mapped to group id. (string value)
#group_id_attribute = cn
group_id_attribute = <%= @ldap["group_id_attribute"] %>

# LDAP attribute mapped to group name. (string value)
#group_name_attribute = ou
group_name_attribute = <%= @ldap["group_name_attribute"] %>

# LDAP attribute mapped to show group membership. (string value)
#group_member_attribute = member
group_member_attribute = <%= @ldap["group_member_attribute"] %>

# LDAP attribute mapped to group description. (string value)
#group_desc_attribute = description
group_desc_attribute = <%= @ldap["group_desc_attribute"] %>

<% if @ldap["group_attribute_ignore"] -%>
# List of attributes stripped off the group on update. (list value)
#group_attribute_ignore =
group_attribute_ignore = <%= @ldap["group_attribute_ignore"] %>
<% end -%>

# Allow group creation in LDAP backend. (boolean value)
#group_allow_create = true
group_allow_create = <%= @ldap["group_allow_create"] %>

# Allow group update in LDAP backend. (boolean value)
#group_allow_update = true
group_allow_update = <%= @ldap["group_allow_update"] %>

# Allow group deletion in LDAP backend. (boolean value)
#group_allow_delete = true
group_allow_delete = <%= @ldap["group_allow_delete"] %>

<% if @ldap['use_pool'] -%>
# Enable LDAP connection pooling. (boolean value)
use_pool = true

# Connection pool size. (integer value)
pool_size = <%= @ldap['pool_size'] %>

# Maximum count of reconnect trials. (integer value)
pool_retry_max = <%= @ldap['pool_retry_max'] %>

# Time span in seconds to wait between two reconnect trials.
# (floating point value)
pool_retry_delay = <%= @ldap['pool_retry_delay'] %>

# Connector timeout in seconds. Value -1 indicates indefinite
# wait for response. (integer value)
pool_connection_timeout = <%= @ldap['pool_connection_timeout'] %>

# Connection lifetime in seconds. (integer value)
pool_connection_lifetime = <%= @ldap['pool_connection_lifetime'] %>

# Enable LDAP connection pooling for end user authentication.
# If use_pool is disabled, then this setting is meaningless
# and is not used at all. (boolean value)
use_auth_pool = <%= @ldap['use_auth_pool'] %>

# End user auth connection pool size. (integer value)
auth_pool_size = <%= @ldap['auth_pool_size'] %>

# End user auth connection lifetime in seconds. (integer
# value)
auth_pool_connection_lifetime = <%= @ldap['auth_pool_connection_lifetime'] %>
<% end -%>


# Enable TLS for communicating with LDAP servers. (boolean value)
#use_tls = false
<% if @ldap["use_tls"] -%>
use_tls = True

# CA certificate file path for communicating with LDAP servers. (string value)
#tls_cacertfile = <None>
# CA certificate directory path for communicating with LDAP servers. (string
# value)
#tls_cacertdir = <None>
<%   if @ldap["tls_cacertfile"] -%>
tls_cacertfile = <%= @ldap["tls_cacertfile"] %>
<%   elsif @ldap["tls_cacertdir"] -%>
tls_cacertdir = <%= @ldap["tls_cacertdir"] %>
<%   end -%>

# Valid options for tls_req_cert are demand, never, and allow. (string value)
#tls_req_cert = demand
<%   if @ldap["tls_req_cert"] -%>
tls_req_cert = <%= @ldap["tls_req_cert"] %>
<% end -%>

<% end -%>

[matchmaker_ring]

#
# Options defined in oslo.messaging
#

# Matchmaker ring file (JSON). (string value)
# Deprecated group/name - [DEFAULT]/matchmaker_ringfile
#ringfile=/etc/oslo/matchmaker_ring.json

[memcache]

#
# Options defined in keystone
#

<% if @memcache_servers -%>
# Memcache servers in the format of "host:port". (list value)
#servers=localhost:11211
servers = <%= @memcache_servers %>
<% end -%>

[oauth1]

#
# From keystone
#

[os_inherit]

#
# From keystone
#

[oslo_messaging_amqp]

#
# From oslo.messaging
#

<% if @mq_service_type == "qpid"  %>
[oslo_messaging_qpid]

#
# From oslo.messaging
#

# Use durable queues in AMQP. (boolean value)
# Deprecated group/name - [DEFAULT]/rabbit_durable_queues
#amqp_durable_queues = false
amqp_durable_queues = <%= node['openstack']['mq']['identity']['durable_queues'] %>

# Auto-delete queues in AMQP. (boolean value)
# Deprecated group/name - [DEFAULT]/amqp_auto_delete
#amqp_auto_delete = false
amqp_auto_delete = <%= node['openstack']['mq']['identity']['auto_delete'] %>

# Size of RPC connection pool. (integer value)
# Deprecated group/name - [DEFAULT]/rpc_conn_pool_size
#rpc_conn_pool_size = 30
rpc_conn_pool_size = <%= node["openstack"]["identity"]["rpc_conn_pool_size"] %>

# Qpid broker hostname. (string value)
# Deprecated group/name - [DEFAULT]/qpid_hostname
#qpid_hostname = localhost
qpid_hostname = <%= node["openstack"]["mq"]["identity"]["qpid"]["host"] %>

# Qpid broker port. (integer value)
# Deprecated group/name - [DEFAULT]/qpid_port
#qpid_port = 5672
qpid_port = <%= node["openstack"]["mq"]["identity"]["qpid"]["port"] %>

# Username for Qpid connection. (string value)
# Deprecated group/name - [DEFAULT]/qpid_username
#qpid_username =
qpid_username = <%= node["openstack"]["mq"]["identity"]["qpid"]["username"] %>

# Password for Qpid connection. (string value)
# Deprecated group/name - [DEFAULT]/qpid_password
#qpid_password =
qpid_password = <%= @mq_password %>

# Space separated list of SASL mechanisms to use for auth. (string value)
# Deprecated group/name - [DEFAULT]/qpid_sasl_mechanisms
#qpid_sasl_mechanisms =
qpid_sasl_mechanisms = <%= node["openstack"]["mq"]["identity"]["qpid"]["sasl_mechanisms"] %>

# Seconds between connection keepalive heartbeats. (integer value)
# Deprecated group/name - [DEFAULT]/qpid_heartbeat
#qpid_heartbeat = 60
qpid_heartbeat = <%= node["openstack"]["mq"]["identity"]["qpid"]["heartbeat"] %>

# Transport to use, either 'tcp' or 'ssl'. (string value)
# Deprecated group/name - [DEFAULT]/qpid_protocol
#qpid_protocol = tcp
qpid_protocol = <%= node["openstack"]["mq"]["identity"]["qpid"]["protocol"] %>

# Whether to disable the Nagle algorithm. (boolean value)
# Deprecated group/name - [DEFAULT]/qpid_tcp_nodelay
#qpid_tcp_nodelay = true
qpid_tcp_nodelay = <%= node["openstack"]["mq"]["identity"]["qpid"]["tcp_nodelay"] %>

# The qpid topology version to use.  Version 1 is what was originally used by
# impl_qpid.  Version 2 includes some backwards-incompatible changes that allow
# broker federation to work.  Users should update to version 2 when they are
# able to take everything down, as it requires a clean break. (integer value)
# Deprecated group/name - [DEFAULT]/qpid_topology_version
#qpid_topology_version = 1
qpid_topology_version = <%= node['openstack']['mq']['identity']['qpid']['topology_version'] %>
<% end -%>

<% if @mq_service_type == "rabbitmq"  -%>
[oslo_messaging_rabbit]

#
# From oslo.messaging
#

# Number of seconds after which the Rabbit broker is considered down if heartbeat's keep-alive fails (0 disable the heartbeat)
heartbeat_timeout_threshold=<%= node['openstack']['mq']['identity']['rabbit']['heartbeat_timeout_threshold'] %>

# How often times during the heartbeat_timeout_threshold we check the heartbeat
heartbeat_rate=<%= node['openstack']['mq']['identity']['rabbit']['heartbeat_rate'] %>

# Use durable queues in AMQP. (boolean value)
# Deprecated group/name - [DEFAULT]/rabbit_durable_queues
#amqp_durable_queues = false
amqp_durable_queues = <%= node['openstack']['mq']['identity']['durable_queues'] %>

# Auto-delete queues in AMQP. (boolean value)
# Deprecated group/name - [DEFAULT]/amqp_auto_delete
#amqp_auto_delete = false
amqp_auto_delete = <%= node['openstack']['mq']['identity']['auto_delete'] %>

# Size of RPC connection pool. (integer value)
# Deprecated group/name - [DEFAULT]/rpc_conn_pool_size
#rpc_conn_pool_size = 30
rpc_conn_pool_size = <%= node["openstack"]["identity"]["rpc_conn_pool_size"] %>

<% if node['openstack']['mq']['identity']['rabbit']['use_ssl'] -%>

# Connect over SSL for RabbitMQ. (boolean value)
rabbit_use_ssl=true

<%   if node['openstack']['mq']['identity']['rabbit']['kombu_ssl_version'] -%>
# SSL version to use (valid only if SSL enabled). valid values
# are TLSv1 and SSLv23. SSLv2 and SSLv3 may be available on
# some distributions. (string value)
kombu_ssl_version=<%= node['openstack']['mq']['identity']['rabbit']['kombu_ssl_version'] %>
<%   end -%>
<%   if node['openstack']['mq']['identity']['rabbit']['kombu_ssl_keyfile'] -%>
# SSL key file (valid only if SSL enabled)
kombu_ssl_keyfile=<%= node['openstack']['mq']['identity']['rabbit']['kombu_ssl_keyfile'] %>
<%   end -%>
<%   if node['openstack']['mq']['identity']['rabbit']['kombu_ssl_certfile'] -%>
# SSL cert file (valid only if SSL enabled)
kombu_ssl_certfile=<%= node['openstack']['mq']['identity']['rabbit']['kombu_ssl_certfile'] %>
<%   end -%>
<%   if node['openstack']['mq']['identity']['rabbit']['kombu_ssl_ca_certs'] -%>
# SSL certification authority file (valid only if SSL enabled)
kombu_ssl_ca_certs=<%= node['openstack']['mq']['identity']['rabbit']['kombu_ssl_ca_certs'] %>
<%   end -%>
# How long to wait before reconnecting in response to an AMQP consumer cancel notification
kombu_reconnect_delay=<%= node['openstack']['mq']['identity']['rabbit']['kombu_reconnect_delay'] %>
# How long to wait before considering a reconnect attempt to have failed.
# This value should not be longer than rpc_response_timeout
kombu_reconnect_timeout=<%= node['openstack']['mq']['identity']['rabbit']['kombu_reconnect_timeout'] %>
<% end -%>

<% if node["openstack"]["mq"]["identity"]["rabbit"]["ha"] %>
# RabbitMQ HA cluster host:port pairs. (list value)
# Deprecated group/name - [DEFAULT]/rabbit_hosts
#rabbit_hosts = $rabbit_host:$rabbit_port
rabbit_hosts = <%= @rabbit_hosts %>

# Use HA queues in RabbitMQ (x-ha-policy: all). If you change this option, you
# must wipe the RabbitMQ database. (boolean value)
# Deprecated group/name - [DEFAULT]/rabbit_ha_queues
#rabbit_ha_queues = false
rabbit_ha_queues = true
<% else -%>
# The RabbitMQ broker address where a single node is used. (string value)
# Deprecated group/name - [DEFAULT]/rabbit_host
#rabbit_host = localhost
rabbit_host = <%= node["openstack"]["mq"]["identity"]["rabbit"]["host"] %>

# The RabbitMQ broker port where a single node is used. (integer value)
# Deprecated group/name - [DEFAULT]/rabbit_port
#rabbit_port = 5672
rabbit_port = <%= node["openstack"]["mq"]["identity"]["rabbit"]["port"] %>
<% end -%>

# The RabbitMQ userid. (string value)
# Deprecated group/name - [DEFAULT]/rabbit_userid
#rabbit_userid = guest
rabbit_userid = <%= node["openstack"]["mq"]["identity"]["rabbit"]["userid"] %>

# The RabbitMQ password. (string value)
# Deprecated group/name - [DEFAULT]/rabbit_password
#rabbit_password = guest
rabbit_password = <%= @mq_password %>

# The RabbitMQ virtual host. (string value)
# Deprecated group/name - [DEFAULT]/rabbit_virtual_host
#rabbit_virtual_host = /
rabbit_virtual_host = <%= node["openstack"]["mq"]["identity"]["rabbit"]["vhost"] %>

# Maximum retries with trying to connect to RabbitMQ
# (the default of 0 implies an infinite retry count)
rabbit_max_retries = <%= node["openstack"]["mq"]["identity"]["rabbit"]["rabbit_max_retries"] %>

# RabbitMQ connection retry interval
rabbit_retry_interval = <%= node["openstack"]["mq"]["identity"]["rabbit"]["rabbit_retry_interval"] %>
<% end -%>

[oslo_middleware]

#
# From oslo.middleware
#
[paste_deploy]

#
# From keystone
#

[policy]

#
# From keystone
#

# Policy backend driver. (string value)
#driver = keystone.policy.backends.sql.Policy
driver = keystone.policy.backends.<%= node["openstack"]["identity"]["policy"]["backend"] %>.Policy

<% if node['openstack']['identity']['policy']['list_limit'] %>
# Maximum number of entities that will be returned in a policy collection.
# (integer value)
#list_limit = <None>
list_limit=<%= node['openstack']['identity']['policy']['list_limit'] %>
<% end %>

[resource]

#
# From keystone
#

[revoke]

#
# From keystone
#

[role]

#
# From keystone
#
[saml]

#
# From keystone
#

# Default TTL, in seconds, for any generated SAML assertion created by
# Keystone. (integer value)
#assertion_expiration_time = 3600
assertion_expiration_time=<%= node["openstack"]["identity"]["saml"]["assertion_expiration_time"] %>

# Binary to be called for XML signing. Install the appropriate package, specify
# absolute path or adjust your PATH environment variable if the binary cannot
# be found. (string value)
#xmlsec1_binary = xmlsec1
xmlsec1_binary=<%= node["openstack"]["identity"]["saml"]["xmlsec1_binary"] %>

# Path of the certfile for SAML signing. For non-production environments, you
# may be interested in using `keystone-manage pki_setup` to generate self-
# signed certificates. Note, the path cannot contain a comma. (string value)
#certfile = /etc/keystone/ssl/certs/signing_cert.pem
certfile=<%= node["openstack"]["identity"]["saml"]["certfile"] %>

# Path of the keyfile for SAML signing. Note, the path cannot contain a comma.
# (string value)
#keyfile = /etc/keystone/ssl/private/signing_key.pem
keyfile=<%= node["openstack"]["identity"]["saml"]["keyfile"] %>

# Entity ID value for unique Identity Provider identification. Usually FQDN is
# set with a suffix. A value is required to generate IDP Metadata. For example:
# https://keystone.example.com/v3/OS-FEDERATION/saml2/idp (string value)
#idp_entity_id = <None>
idp_entity_id=<%= node["openstack"]["identity"]["saml"]["idp_entity_id"] %>

# Identity Provider Single-Sign-On service value, required in the Identity
# Provider's metadata. A value is required to generate IDP Metadata. For
# example: https://keystone.example.com/v3/OS-FEDERATION/saml2/sso (string
# value)
#idp_sso_endpoint = <None>
idp_sso_endpoint=<%= node["openstack"]["identity"]["saml"]["idp_sso_endpoint"] %>

# Language used by the organization. (string value)
#idp_lang = en
idp_lang=<%= node["openstack"]["identity"]["saml"]["idp_lang"] %>

# Organization name the installation belongs to. (string value)
#idp_organization_name = <None>
idp_organization_name=<%= node["openstack"]["identity"]["saml"]["idp_organization_name"] %>

# Organization name to be displayed. (string value)
#idp_organization_display_name = <None>
idp_organization_display_name=<%= node["openstack"]["identity"]["saml"]["idp_organization_display_name"] %>

# URL of the organization. (string value)
#idp_organization_url = <None>
idp_organization_url=<%= node["openstack"]["identity"]["saml"]["idp_organization_url"] %>

# Company of contact person. (string value)
#idp_contact_company = <None>
idp_contact_company=<%= node["openstack"]["identity"]["saml"]["idp_contact_company"] %>

# Given name of contact person (string value)
#idp_contact_name = <None>
idp_contact_name=<%= node["openstack"]["identity"]["saml"]["idp_contact_name"] %>

# Surname of contact person. (string value)
#idp_contact_surname = <None>
idp_contact_surname=<%= node["openstack"]["identity"]["saml"]["idp_contact_surname"] %>

# Email address of contact person. (string value)
#idp_contact_email = <None>
idp_contact_email=<%= node["openstack"]["identity"]["saml"]["idp_contact_email"] %>

# Telephone number of contact person. (string value)
#idp_contact_telephone = <None>
idp_contact_telephone=<%= node["openstack"]["identity"]["saml"]["idp_contact_telephone"] %>

# Contact type. Allowed values are: technical, support, administrative billing,
# and other (string value)
#idp_contact_type = other
idp_contact_type=<%= node["openstack"]["identity"]["saml"]["idp_contact_type"] %>

# Path to the Identity Provider Metadata file. This file should be generated
# with the keystone-manage saml_idp_metadata command. (string value)
#idp_metadata_path = /etc/keystone/saml2_idp_metadata.xml
idp_metadata_path=<%= node["openstack"]["identity"]["saml"]["idp_metadata_path"] %>

[signing]

#
# From keystone
#

<% if node["openstack"]["auth"]["strategy"] == "pki" -%>
# Path of the certfile for token signing. For non-production environments, you
# may be interested in using `keystone-manage pki_setup` to generate self-
# signed certificates. (string value)
#certfile = /etc/keystone/ssl/certs/signing_cert.pem
certfile = <%= node["openstack"]["identity"]["signing"]["certfile"] %>

# Path of the keyfile for token signing. (string value)
#keyfile = /etc/keystone/ssl/private/signing_key.pem
keyfile = <%= node["openstack"]["identity"]["signing"]["keyfile"] %>

# Path of the CA for token signing. (string value)
#ca_certs = /etc/keystone/ssl/certs/ca.pem
ca_certs = <%= node["openstack"]["identity"]["signing"]["ca_certs"] %>

# Key size (in bits) for token signing cert (auto generated certificate).
# (integer value)
#key_size = 2048
key_size = <%= node["openstack"]["identity"]["signing"]["key_size"] %>

# Days the token signing cert is valid for (auto generated certificate).
# (integer value)
#valid_days = 3650
valid_days = <%= node["openstack"]["identity"]["signing"]["valid_days"] %>

# TODO: Is this used anymore?
ca_password = <%= node["openstack"]["identity"]["signing"]["ca_password"] %>
<% end -%>

[ssl]

#
# From keystone
#

[token]

#
# From keystone
#

# Amount of time a token should remain valid (in seconds). (integer value)
#expiration = 3600
expiration = <%= node["openstack"]["identity"]["token"]["expiration"] %>

# Controls the token construction, validation, and revocation operations. Core
# providers are "keystone.token.providers.[fernet|pkiz|pki|uuid].Provider". The
# default provider is uuid. (string value)
#provider = keystone.token.providers.uuid.Provider
provider = keystone.token.providers.<%= node["openstack"]["auth"]["strategy"] %>.Provider

# Token persistence backend driver. (string value)
#driver = keystone.token.persistence.backends.sql.Token
driver = keystone.token.persistence.backends.<%= node["openstack"]["identity"]["token"]["backend"] %>.Token

# The hash algorithm to use for PKI tokens. This can be set to any algorithm
# that hashlib supports. WARNING: Before changing this value, the auth_token
# middleware must be configured with the hash_algorithms, otherwise token
# revocation will not be processed correctly. (string value)
#hash_algorithm = md5
hash_algorithm = <%= node["openstack"]["identity"]["token"]["hash_algorithm"] %>

[trust]

#
# From keystone
#

# Misc options
<% if node["openstack"]["identity"]["misc_keystone"] %>
<% node["openstack"]["identity"]["misc_keystone"].each do |m| %>
<%= m %>
<% end %>
<% end %>
